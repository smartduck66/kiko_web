<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8"/>
        <title>KIKO</title>
        <meta name="description" content="Outil climatique" />
        <meta name="viewport" content="width=device-width,initial-scale=1.0" /> 
        <!--
        <link rel="stylesheet" href="assets/css/styles.css" >
        <link
        rel="preload"
        href="assets/fonts/inter.var.woff2"
        as="font"
        type="font/woff2"
        crossorigin
        />
        -->
        <link rel="apple-touch-icon" sizes="180x180" href="assets/favicon/apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="assets/favicon/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="assets/favicon/favicon-16x16.png">
        <link rel="manifest" href="assets/favicon/site.webmanifest">
    </head>
    <body>

        <div> 
            <b>Référence climatique</b>
            <p><span id="Référence"></span></p>
            
            <label>Température moyenne annuelle (saisir MIN et MAX en degrés celsius)....... : 
                <input type="text" id="min_temp" value="" size="1"> 
                <input type="text" id="max_temp" value="" size="1"> 
            </label>         
            <button id="temp_btn" onClick="filtre()">GO</button>
            
            <textarea id="results" rows="35" cols="230"></textarea> 

        </div> 
    </body>

    <script>
        // Load du fichier json contenant l'ensemble des fiches climatiques
        fetch("https://confident-edison-4570c2.netlify.app/assets/data/fc.json")
             
             .then(function (response) {
                 return response.json();
             })
             .then(function (data) {
                localStorage.clear();
                localStorage.fc = JSON.stringify(data);    // Stockage local du fichier json pour le réutiliser lors de cette session
                document.getElementById('Référence').innerHTML = fiche_climatique("78640001"); // Affichage valeur de référence
             })
             .catch(function (err) {
                 console.log('error: ' + err);
             });
 
        function fiche_climatique(ref) {
            // Construction d'une "ligne HTML" avec les données climatiques d'un indicatif passé en paramètre (ref)

            let data = JSON.parse(localStorage.fc); // Récupération locale des fiches climatiques

            let station = data[data.findIndex(x => x.indicatif == ref)]
            let s = [];
            s.push(station.indicatif);
            s.push(" - ");
            s.push(station.ville.padEnd(20).slice(0,20));   // 20 caractères max pour la ville
            s.push(" (");
            s.push(station.altitude);
            s.push(" m) - T moy : ");
            s.push(station.temp_moy);
            s.push("° - T min : ");
            s.push(station.temp_min);
            s.push("° - T max : ");
            s.push(station.temp_max);
            s.push("° - Soleil : ");
            if (isNaN(station.ensoleillement)) {s.push(0);} else {s.push(Math.trunc(Number(station.ensoleillement)));}  // Ternary operator does not run...
            s.push(" h/an - Pluie : ");
            if (isNaN(station.pluie)) {s.push(0);} else {s.push(Math.trunc(Number(station.pluie)));}
            s.push(" mm/mois - Rafales de vent : ");
            if (isNaN(station.vent)) {s.push(0);} else {s.push(Math.trunc(Number(station.vent)));}
            s.push(" j/an - Dist. Centrale : ");
            s.push(station.distance_cnpe);
            s.push(" kms - Prix maisons : ");
            s.push(station.prix_maisons);
            s.push(" €/m2");

            return "".concat(...s);
        }
        
         function filtre() {
            // Filtre

            let data = JSON.parse(localStorage.fc); // Récupération locale des fiches climatiques

            // Récupération et sécurisation des paramétres saisis
            let p1 = document.getElementById('min_temp').value;
            let p2 = document.getElementById('max_temp').value;
            if (p1 > p2) {
                p1 = p2;
                document.getElementById('min_temp').value = p1;
            }
            if (p2 < p1) {
                p2 = p1;
                document.getElementById('max_temp').value = p2;
            }

            // Sélection des fiches climatiques
            let results = data.filter(x => x.temp_moy >= p1 && x.temp_moy <= p2 );
            let s = [];
            for (let i=0;i< results.length; i++) {
                s.push(fiche_climatique(results[i].indicatif));
                s.push("\n");

            }
            document.getElementById('results').innerHTML = "".concat(...s);
         }
  
    </script>
    
</html>