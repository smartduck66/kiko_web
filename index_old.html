<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8"/>
        <title>KIKO</title>
        <meta name="description" content="Outil climatique" />
        <meta name="viewport" content="width=device-width,initial-scale=1.0" /> 
        <link rel="apple-touch-icon" sizes="180x180" href="assets/favicon/apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="assets/favicon/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="assets/favicon/favicon-16x16.png">
        <link rel="manifest" href="assets/favicon/site.webmanifest">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css">
        <script src="https://kit.fontawesome.com/1046b8e22f.js" crossorigin="anonymous"></script>
    </head>
    <body>
        <section class="section">      
      
            <div class="columns">
                <div class="column">
                  <p class="bd-notification is-info"><b>[7864001] Villacoublay (174 m)</b></p>
                  <div class="columns is-mobile">
                    <div class="column is-two-fifths">
                        <p>
                        <span class="icon-text">
                            <span class="icon">
                              <i class="fas fa-thermometer-half"></i>
                            </span>
                            <span>11.9d</span>
                        </span>
                        </p>
                        <p>
                        <span class="icon-text">
                            <span class="icon">
                              <i class="fas fa-temperature-low"></i>
                            </span>
                            <span>5.9d</span>
                        </span>
                        </p>
                        <p>
                        <span class="icon-text">
                            <span class="icon">
                              <i class="fas fa-temperature-high"></i>
                            </span>
                            <span>16.9d</span>
                        </span>
                        </p>
                        <p>
                            <span class="icon-text">
                                <span class="icon ">
                                  <i class="fas fa-atom"></i>
                                </span>
                                <span>100 kms</span>
                            </span>
                        </p>
                    </div>
                    <div class="column">
                        <p>
                        <span class="icon-text">
                            <span class="icon">
                              <i class="fas fa-sun"></i>
                            </span>
                            <span>1890 h/an</span>
                        </span>
                        </p>
                        <p>
                        <span class="icon-text">
                            <span class="icon">
                              <i class="fas fa-cloud-rain"></i>
                            </span>
                            <span>780 mm/mois</span>
                        </span>
                        </p>
                        <p>
                            <span class="icon-text">
                                <span class="icon ">
                                  <i class="fas fa-wind"></i>
                                </span>
                                <span>44 j/an</span>
                            </span>
                        </p>
                        <p>
                            <span class="icon-text">
                                <span class="icon ">
                                  <i class="fas fa-home"></i>
                                </span>
                                <span>2300 €/m2</span>
                            </span>
                        </p>
                    </div>
                  </div>
                </div>
                
            </div>
        
          </section>
        




        <div> 
            <b>Référence climatique</b>
            <p><span id="Référence"></span></p>
            <button style="font-size: 1em; background-color: rgba(220, 0, 0, 1); color: rgba(255, 255, 255, 255)" id="Reset_Filtres" onClick="ResetFiltres();">Réinitialiser les filtres</button>
            <br>
            <label>Température moyenne annuelle (saisir MIN et MAX en degrés celsius)....... : 
                <input type="text" id="min_temp" value="" size="1"> 
                <input type="text" id="max_temp" value="" size="1"> 
            </label>
            <br>
            <label>Durée d'insolation moyenne (saisir MIN et MAX en heures/an).....................: 
                <input type="text" id="min_soleil" value="" size="1"> 
                <input type="text" id="max_soleil" value="" size="1"> 
            </label>
            <br>
            <label>Hauteur moyenne mensuelle des précipitations (saisir MIN et MAX en mm) : 
                <input type="text" id="min_pluie" value="" size="1"> 
                <input type="text" id="max_pluie" value="" size="1"> 
            </label>         
            <br>
            <label>Nombre moyen de jours/an avec rafales (saisir MIN et MAX)....................... : 
                <input type="text" id="min_vent" value="" size="1"> 
                <input type="text" id="max_vent" value="" size="1"> 
            </label>           
            <button id="filtres" onClick="filtres()">GO</button>
            <br>
            <label>Fiches d'un département : 
                <input type="text" id="fiches_dep" value="78" size="1"> 
            </label>         
            <button id="fiches_dep_btn" onClick="departement()">GO</button>         
            <br> 
            <label>  Nombre d'occurences trouvées : </label><span id="occurences"></span>
            <br>

            <textarea id="results" rows="35" cols="230"></textarea> 

        </div> 
    </body>

    <script>
        // Load du fichier json contenant l'ensemble des fiches climatiques
        fetch("https://confident-edison-4570c2.netlify.app/assets/data/fc.json")
             
             .then(function (response) {
                 return response.json();
             })
             .then(function (data) {
                localStorage.clear();
                localStorage.fc = JSON.stringify(data);    // Stockage local du fichier json pour le réutiliser lors de cette session
                document.getElementById('Référence').innerHTML = fiche_climatique("78640001"); // Affichage valeur de référence
             })
             .catch(function (err) {
                 console.log('error: ' + err);
             });
 
        function fiche_climatique(ref) {
            // Construction d'une "ligne HTML" avec les données climatiques d'un indicatif passé en paramètre (ref)

            let data = JSON.parse(localStorage.fc); // Récupération locale des fiches climatiques

            let station = data[data.findIndex(x => x.indicatif == ref)]
            let s = [];
            s.push(station.indicatif);
            s.push(" - ");
            s.push(station.ville.padEnd(20).slice(0,20));   // 20 caractères max pour la ville
            s.push(" (");
            s.push(station.altitude);
            s.push(" m) - T moy : ");
            s.push(station.temp_moy);
            s.push("° - T min : ");
            s.push(station.temp_min);
            s.push("° - T max : ");
            s.push(station.temp_max);
            s.push("° - Soleil : ");
            if (isNaN(station.ensoleillement)) {s.push(0);} else {s.push(Math.trunc(Number(station.ensoleillement)));}  // Ternary operator does not run...
            s.push(" h/an - Pluie : ");
            if (isNaN(station.pluie)) {s.push(0);} else {s.push(Math.trunc(Number(station.pluie)));}
            s.push(" mm/mois - Rafales de vent : ");
            if (isNaN(station.vent)) {s.push(0);} else {s.push(Math.trunc(Number(station.vent)));}
            s.push(" j/an - Dist. Centrale : ");
            s.push(station.distance_cnpe);
            s.push(" kms - Prix maisons : ");
            s.push(station.prix_maisons);
            s.push(" €/m2");

            return "".concat(...s);
        }
        
        function affichage_fiches(results){
            // Affichage des fiches
            let s = [];
            for (let i=0;i< results.length; i++) {
                s.push(fiche_climatique(results[i].indicatif));
                s.push("\n");

            }
            document.getElementById('results').innerHTML = "".concat(...s);
            document.getElementById('occurences').innerHTML = results.length;
        } 

        function filtres() {
            // Filtres

            let data = JSON.parse(localStorage.fc); // Récupération locale des fiches climatiques

            // Récupération et sécurisation des paramétres saisis
            let p1 = document.getElementById('min_temp').value;
            let p2 = document.getElementById('max_temp').value;
            if (p1 > p2) {
                p1 = p2;
                document.getElementById('min_temp').value = p1;
            }
            if (p2 < p1) {
                p2 = p1;
                document.getElementById('max_temp').value = p2;
            }

            let p3 = document.getElementById('min_soleil').value;
            let p4 = document.getElementById('max_soleil').value;
            if (p3 > p4) {
                p3 = p4;
                document.getElementById('min_soleil').value = p3;
            }
            if (p4 < p3) {
                p4 = p3;
                document.getElementById('max_soleil').value = p4;
            }
            let p5 = document.getElementById('min_pluie').value;
            let p6 = document.getElementById('max_pluie').value;
            if (p5 > p6) {
                p5 = p6;
                document.getElementById('min_pluie').value = p5;
            }
            if (p6 < p5) {
                p6 = p5;
                document.getElementById('max_pluie').value = p6;
            }
            let p7 = document.getElementById('min_vent').value;
            let p8 = document.getElementById('max_vent').value;
            if (p7 > p8) {
                p7 = p8;
                document.getElementById('min_vent').value = p7;
            }
            if (p8 < p7) {
                p8 = p7;
                document.getElementById('max_vent').value = p8;
            }

            // Sélection des fiches climatiques
            let results = data;
            if (p1 != "" && p2 != "") {results = results.filter(x => x.temp_moy >= p1 && x.temp_moy <= p2);}
            if (p3 != "" && p4 != "") {results = results.filter(x => x.ensoleillement >= p3 && x.ensoleillement <= p4);}
            if (p5 != "" && p6 != "") {results = results.filter(x => x.pluie >= p5 && x.pluie <= p6);}
            if (p7 != "" && p8 != "") {results = results.filter(x => x.vent >= p7 && x.vent <= p8);}
            
            affichage_fiches(results);
        }
  
        function departement() {
            // Fiches d'un département donné

            let data = JSON.parse(localStorage.fc); // Récupération locale des fiches climatiques

            // Récupération et sécurisation du paramétre saisi
            let p1 = document.getElementById('fiches_dep').value;

            // Sélection des fiches climatiques
            let results = data;
            if (p1 != "") {results = results.filter(x => x.departement == p1);}

            affichage_fiches(results);
        }

        function ResetFiltres() {
            document.getElementById('min_temp').value = "";
            document.getElementById('max_temp').value = "";
            document.getElementById('min_soleil').value = "";
            document.getElementById('max_soleil').value = "";
            document.getElementById('min_pluie').value = "";
            document.getElementById('max_pluie').value = "";
            document.getElementById('min_vent').value = "";
            document.getElementById('max_vent').value = "";
            document.getElementById('occurences').innerHTML = "";
            document.getElementById('fiches_dep').value = "78";
            document.getElementById('results').innerHTML = "Les filtres ont été réinitialisés.";
			
		}    

    </script>
    
</html>